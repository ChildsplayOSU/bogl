<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module      : Runtime.Eval
Description : Interpreter for Spiel
Copyright   : (c)
License     : BSD-3
-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Runtime.Eval</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Syntax.html"><span class="hs-identifier">Language.Syntax</span></a><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><a href="Runtime.Values.html"><span class="hs-identifier">Runtime.Values</span></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><a href="Runtime.Monad.html"><span class="hs-identifier">Runtime.Monad</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="Runtime.Builtins.html"><span class="hs-identifier">Runtime.Builtins</span></a><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Array</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Writer</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.State</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Text.Parsec.Pos</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-comment">-- | Produce all of the bindings from a list of value definitions.</span><span>
</span><a name="line-24"></a><span class="hs-comment">--   This is done sequentially. Errors are reported as they're found.</span><span>
</span><a name="line-25"></a><span class="hs-identifier">bindings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Language.Syntax.html#ValDef"><span class="hs-identifier hs-type">ValDef</span></a><span> </span><a href="#local-6989586621679172375"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Writer</span><span> </span><span class="hs-special">[</span><a href="Runtime.Monad.html#Exception"><span class="hs-identifier hs-type">Exception</span></a><span class="hs-special">]</span><span> </span><a href="Runtime.Monad.html#Env"><span class="hs-identifier hs-type">Env</span></a><span>
</span><a name="line-26"></a><a name="bindings"><a href="Runtime.Eval.html#bindings"><span class="hs-identifier">bindings</span></a></a><span> </span><a name="local-6989586621679172673"><a href="#local-6989586621679172673"><span class="hs-identifier">sz</span></a></a><span> </span><a name="local-6989586621679172674"><a href="#local-6989586621679172674"><span class="hs-identifier">vs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679172675"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-27"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-28"></a><span>    </span><a name="local-6989586621679172675"><a href="#local-6989586621679172675"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679172676"><a href="#local-6989586621679172676"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679172677"><a href="#local-6989586621679172677"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679172678"><a href="#local-6989586621679172678"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Runtime.Monad.html#runEval"><span class="hs-identifier hs-var">runEval</span></a><span> </span><a href="#local-6989586621679172676"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679172678"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-29"></a><span>                                </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679172679"><a href="#local-6989586621679172679"><span class="hs-identifier">v'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Monad.html#modifyEval"><span class="hs-identifier hs-var">modifyEval</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621679172677"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679172679"><span class="hs-identifier hs-var">v'</span></a><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679172676"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-30"></a><span>                                </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679172680"><a href="#local-6989586621679172680"><span class="hs-identifier">_err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tell</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679172680"><span class="hs-identifier hs-var">_err</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679172676"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span>        </span><span class="hs-special">(</span><a href="Runtime.Monad.html#emptyEnv"><span class="hs-identifier hs-var">emptyEnv</span></a><span> </span><a href="#local-6989586621679172673"><span class="hs-identifier hs-var">sz</span></a><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Runtime.Eval.html#bind"><span class="hs-identifier hs-var">bind</span></a><span> </span><a href="#local-6989586621679172674"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-comment">-- | Partial application of of args to 'bindings', allows passing in just a list of ValDefs</span><span>
</span><a name="line-35"></a><span class="hs-identifier">bindings_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Language.Syntax.html#ValDef"><span class="hs-identifier hs-type">ValDef</span></a><span> </span><a href="#local-6989586621679172374"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Monad.html#Env"><span class="hs-identifier hs-type">Env</span></a><span>
</span><a name="line-36"></a><a name="bindings_"><a href="Runtime.Eval.html#bindings_"><span class="hs-identifier">bindings_</span></a></a><span> </span><a name="local-6989586621679172834"><a href="#local-6989586621679172834"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679172835"><a href="#local-6989586621679172835"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">runWriter</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Runtime.Eval.html#bindings"><span class="hs-identifier hs-var">bindings</span></a><span> </span><a href="#local-6989586621679172834"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679172835"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-comment">-- | Binds a ValDef to a name and a Val in the Eval monad</span><span>
</span><a name="line-39"></a><span class="hs-identifier">bind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#ValDef"><span class="hs-identifier hs-type">ValDef</span></a><span> </span><a href="#local-6989586621679172373"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">,</span><span> </span><a href="Runtime.Monad.html#Eval"><span class="hs-identifier hs-type">Eval</span></a><span> </span><a href="Runtime.Values.html#Val"><span class="hs-identifier hs-type">Val</span></a><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-comment">-- | Binds a value equation</span><span>
</span><a name="line-41"></a><a name="bind"><a href="Runtime.Eval.html#bind"><span class="hs-identifier">bind</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Val"><span class="hs-identifier hs-var">Val</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Veq"><span class="hs-identifier hs-var">Veq</span></a><span> </span><a name="local-6989586621679172836"><a href="#local-6989586621679172836"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679172837"><a href="#local-6989586621679172837"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-42"></a><span>  </span><span class="hs-special">(</span><a href="#local-6989586621679172836"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-43"></a><span>    </span><a name="local-6989586621679172838"><a href="#local-6989586621679172838"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Monad.html#getEnv"><span class="hs-identifier hs-var">getEnv</span></a><span>
</span><a name="line-44"></a><span>    </span><span class="hs-comment">-- bind as a Pending Value</span><span>
</span><a name="line-45"></a><span>    </span><span class="hs-comment">-- this allows lazy evaluation of vals that use input at runtime</span><span>
</span><a name="line-46"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Values.html#Pv"><span class="hs-identifier hs-var">Pv</span></a><span> </span><a href="#local-6989586621679172838"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#clearAnn"><span class="hs-identifier hs-var">clearAnn</span></a><span> </span><a href="#local-6989586621679172837"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-comment">-- | Binds a function equation</span><span>
</span><a name="line-48"></a><span class="hs-identifier">bind</span><span>  </span><span class="hs-special">(</span><a href="Language.Syntax.html#Val"><span class="hs-identifier hs-var">Val</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Feq"><span class="hs-identifier hs-var">Feq</span></a><span> </span><a name="local-6989586621679172839"><a href="#local-6989586621679172839"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Pars"><span class="hs-identifier hs-var">Pars</span></a><span> </span><a name="local-6989586621679172840"><a href="#local-6989586621679172840"><span class="hs-identifier">ls</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679172841"><a href="#local-6989586621679172841"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679172839"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-49"></a><span>                                        </span><a name="local-6989586621679172842"><a href="#local-6989586621679172842"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Monad.html#getEnv"><span class="hs-identifier hs-var">getEnv</span></a><span>
</span><a name="line-50"></a><span>                                        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Values.html#Vf"><span class="hs-identifier hs-var">Vf</span></a><span> </span><a href="#local-6989586621679172840"><span class="hs-identifier hs-var">ls</span></a><span> </span><a href="#local-6989586621679172842"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#clearAnn"><span class="hs-identifier hs-var">clearAnn</span></a><span> </span><a href="#local-6989586621679172841"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-comment">-- | Binds a board equation</span><span>
</span><a name="line-52"></a><span class="hs-identifier">bind</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#BVal"><span class="hs-identifier hs-var">BVal</span></a><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Sig"><span class="hs-identifier hs-var">Sig</span></a><span> </span><a name="local-6989586621679172843"><a href="#local-6989586621679172843"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679172844"><a href="#local-6989586621679172844"><span class="hs-identifier">defs</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679172843"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-53"></a><span>      </span><a name="local-6989586621679172856"><a href="#local-6989586621679172856"><span class="hs-identifier">sz</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Monad.html#getBounds"><span class="hs-identifier hs-var">getBounds</span></a><span>
</span><a name="line-54"></a><span>      </span><a name="local-6989586621679173264"><a href="#local-6989586621679173264"><span class="hs-identifier">values</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">boardExpr</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679172844"><span class="hs-identifier hs-var">defs</span></a><span>
</span><a name="line-55"></a><span>      </span><a name="local-6989586621679173265"><a href="#local-6989586621679173265"><span class="hs-identifier">maybeBoard</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Monad.html#lookupName"><span class="hs-identifier hs-var">lookupName</span></a><span> </span><a href="#local-6989586621679172843"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-56"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679173265"><span class="hs-identifier hs-var">maybeBoard</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-57"></a><span>         </span><span class="hs-identifier hs-var">Nothing</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Values.html#Vboard"><span class="hs-identifier hs-var">Vboard</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679172846"><span class="hs-identifier hs-var">fill</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679172845"><span class="hs-identifier hs-var">newBoard</span></a><span> </span><a href="#local-6989586621679172856"><span class="hs-identifier hs-var">sz</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679172856"><span class="hs-identifier hs-var">sz</span></a><span> </span><a href="#local-6989586621679172844"><span class="hs-identifier hs-var">defs</span></a><span> </span><a href="#local-6989586621679173264"><span class="hs-identifier hs-var">values</span></a><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span>         </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Runtime.Values.html#Vboard"><span class="hs-identifier hs-var">Vboard</span></a><span> </span><a name="local-6989586621679173266"><a href="#local-6989586621679173266"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Values.html#Vboard"><span class="hs-identifier hs-var">Vboard</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679172846"><span class="hs-identifier hs-var">fill</span></a><span> </span><a href="#local-6989586621679173266"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679172856"><span class="hs-identifier hs-var">sz</span></a><span> </span><a href="#local-6989586621679172844"><span class="hs-identifier hs-var">defs</span></a><span> </span><a href="#local-6989586621679173264"><span class="hs-identifier hs-var">values</span></a><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span>         </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;TODO&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-61"></a><span>      </span><a name="local-6989586621679172845"><a href="#local-6989586621679172845"><span class="hs-identifier">newBoard</span></a></a><span> </span><a name="local-6989586621679172847"><a href="#local-6989586621679172847"><span class="hs-identifier">sz</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">array</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679172847"><span class="hs-identifier hs-var">sz</span></a><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679172848"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><a href="#local-6989586621679172849"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679172848"><a href="#local-6989586621679172848"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621679172847"><span class="hs-identifier hs-var">sz</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679172849"><a href="#local-6989586621679172849"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621679172847"><span class="hs-identifier hs-var">sz</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">repeat</span><span> </span><span class="hs-special">(</span><a href="Runtime.Values.html#Vs"><span class="hs-identifier hs-var">Vs</span></a><span> </span><span class="hs-string">&quot;?&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>      </span><a name="local-6989586621679172846"><a href="#local-6989586621679172846"><span class="hs-identifier">fill</span></a></a><span> </span><a name="local-6989586621679172850"><a href="#local-6989586621679172850"><span class="hs-identifier">_board</span></a></a><span> </span><a name="local-6989586621679172851"><a href="#local-6989586621679172851"><span class="hs-identifier">sz</span></a></a><span> </span><a name="local-6989586621679172852"><a href="#local-6989586621679172852"><span class="hs-identifier">ds</span></a></a><span> </span><a name="local-6989586621679172853"><a href="#local-6989586621679172853"><span class="hs-identifier">vs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679172854"><a href="#local-6989586621679172854"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679172855"><a href="#local-6989586621679172855"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Eval.html#updateBoard"><span class="hs-identifier hs-var">updateBoard</span></a><span> </span><a href="#local-6989586621679172854"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679172851"><span class="hs-identifier hs-var">sz</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621679172855"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621679172855"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679172850"><span class="hs-identifier hs-var">_board</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679172852"><span class="hs-identifier hs-var">ds</span></a><span> </span><a href="#local-6989586621679172853"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-comment">-- | Updates a board</span><span>
</span><a name="line-66"></a><span class="hs-identifier">updateBoard</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Runtime.Values.html#Board"><span class="hs-identifier hs-type">Board</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#BoardEq"><span class="hs-identifier hs-type">BoardEq</span></a><span> </span><a href="#local-6989586621679172372"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Values.html#Val"><span class="hs-identifier hs-type">Val</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Values.html#Board"><span class="hs-identifier hs-type">Board</span></a><span>
</span><a name="line-67"></a><a name="updateBoard"><a href="Runtime.Eval.html#updateBoard"><span class="hs-identifier">updateBoard</span></a></a><span> </span><a name="local-6989586621679173281"><a href="#local-6989586621679173281"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679173282"><a href="#local-6989586621679173282"><span class="hs-identifier">sz</span></a></a><span> </span><a name="local-6989586621679173283"><a href="#local-6989586621679173283"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621679173284"><a href="#local-6989586621679173284"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679173285"><a href="#local-6989586621679173285"><span class="hs-identifier">_indices</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">range</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679173282"><span class="hs-identifier hs-var">sz</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-68"></a><span>                              </span><a href="#local-6989586621679173281"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">//</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><a href="Runtime.Eval.html#posMatches"><span class="hs-identifier hs-var">posMatches</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">xpos</span><span> </span><a href="#local-6989586621679173283"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ypos</span><span> </span><a href="#local-6989586621679173283"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679173285"><span class="hs-identifier hs-var">_indices</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">repeat</span><span> </span><a href="#local-6989586621679173284"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-comment">-- | Check if a Pos matches a coordinate pair</span><span>
</span><a name="line-71"></a><span class="hs-identifier">posMatches</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Syntax.html#Pos"><span class="hs-identifier hs-type">Pos</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Syntax.html#Pos"><span class="hs-identifier hs-type">Pos</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-72"></a><a name="posMatches"><a href="Runtime.Eval.html#posMatches"><span class="hs-identifier">posMatches</span></a></a><span> </span><a name="local-6989586621679173286"><a href="#local-6989586621679173286"><span class="hs-identifier">xp</span></a></a><span> </span><a name="local-6989586621679173287"><a href="#local-6989586621679173287"><span class="hs-identifier">yp</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679173288"><a href="#local-6989586621679173288"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679173289"><a href="#local-6989586621679173289"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679173290"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621679173286"><span class="hs-identifier hs-var">xp</span></a><span> </span><a href="#local-6989586621679173288"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679173290"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621679173287"><span class="hs-identifier hs-var">yp</span></a><span> </span><a href="#local-6989586621679173289"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-73"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-74"></a><span>      </span><a name="local-6989586621679173290"><a href="#local-6989586621679173290"><span class="hs-identifier">match</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#ForAll"><span class="hs-identifier hs-var">ForAll</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-75"></a><span>      </span><span class="hs-identifier">match</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a><span> </span><a name="local-6989586621679173291"><a href="#local-6989586621679173291"><span class="hs-identifier">ix</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679173292"><a href="#local-6989586621679173292"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679173291"><span class="hs-identifier hs-var">ix</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679173292"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-comment">-- | Attempt to access a position on the board that may be invalid</span><span>
</span><a name="line-78"></a><span class="hs-comment">-- If the position is invalid, return an Err value instead of causing an actual array access error</span><span>
</span><a name="line-79"></a><span class="hs-identifier">tryUnsafeBoardAccess</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Values.html#Board"><span class="hs-identifier hs-type">Board</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Values.html#Val"><span class="hs-identifier hs-type">Val</span></a><span>
</span><a name="line-80"></a><a name="tryUnsafeBoardAccess"><a href="Runtime.Eval.html#tryUnsafeBoardAccess"><span class="hs-identifier">tryUnsafeBoardAccess</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679173293"><a href="#local-6989586621679173293"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><a name="local-6989586621679173294"><a href="#local-6989586621679173294"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679173295"><a href="#local-6989586621679173295"><span class="hs-identifier">arr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-special">(</span><a name="local-6989586621679173296"><a href="#local-6989586621679173296"><span class="hs-identifier">bx</span></a></a><span class="hs-special">,</span><a name="local-6989586621679173297"><a href="#local-6989586621679173297"><span class="hs-identifier">by</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bounds</span><span> </span><a href="#local-6989586621679173295"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-81"></a><span>   </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173293"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679173293"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679173296"><span class="hs-identifier hs-var">bx</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679173294"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679173294"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679173297"><span class="hs-identifier hs-var">by</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-82"></a><span>     </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679173295"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173293"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><a href="#local-6989586621679173294"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- good index</span><span>
</span><a name="line-83"></a><span>     </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Values.html#Err"><span class="hs-identifier hs-var">Err</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679173298"><span class="hs-identifier hs-var">p1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679173299"><span class="hs-identifier hs-var">p2</span></a><span>
</span><a name="line-84"></a><span>         </span><span class="hs-keyword">where</span><span>
</span><a name="line-85"></a><span>            </span><a name="local-6989586621679173298"><a href="#local-6989586621679173298"><span class="hs-identifier">p1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Could not access (&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679173293"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;,&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679173294"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;) on the board, &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-86"></a><span>              </span><span class="hs-string">&quot;this is not a valid space. &quot;</span><span>
</span><a name="line-87"></a><span>            </span><a name="local-6989586621679173299"><a href="#local-6989586621679173299"><span class="hs-identifier">p2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679173296"><span class="hs-identifier hs-var">bx</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679173297"><span class="hs-identifier hs-var">by</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679173296"><span class="hs-identifier hs-var">bx</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;The board only has one space at (1,1).&quot;</span><span>
</span><a name="line-88"></a><span>                                     </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;The board size is (&quot;</span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679173296"><span class="hs-identifier hs-var">bx</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;,&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679173297"><span class="hs-identifier hs-var">by</span></a><span> </span><span class="hs-operator hs-var">++</span><span class="hs-string">&quot;).&quot;</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-comment">-- | Binary operation evaluation</span><span>
</span><a name="line-91"></a><span class="hs-identifier">evalBinOp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621679172371"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621679172371"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Monad.html#Eval"><span class="hs-identifier hs-type">Eval</span></a><span> </span><a href="Runtime.Values.html#Val"><span class="hs-identifier hs-type">Val</span></a><span>
</span><a name="line-92"></a><a name="evalBinOp"><a href="Runtime.Eval.html#evalBinOp"><span class="hs-identifier">evalBinOp</span></a></a><span> </span><a href="Language.Syntax.html#Plus"><span class="hs-identifier hs-var">Plus</span></a><span> </span><a name="local-6989586621679173300"><a href="#local-6989586621679173300"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679173301"><a href="#local-6989586621679173301"><span class="hs-identifier">r</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Runtime.Eval.html#evalNumOp"><span class="hs-identifier hs-var">evalNumOp</span></a><span> </span><span class="hs-string">&quot;+&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679173300"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621679173301"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-93"></a><span class="hs-identifier">evalBinOp</span><span> </span><a href="Language.Syntax.html#Minus"><span class="hs-identifier hs-var">Minus</span></a><span> </span><a name="local-6989586621679173302"><a href="#local-6989586621679173302"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679173303"><a href="#local-6989586621679173303"><span class="hs-identifier">r</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Runtime.Eval.html#evalNumOp"><span class="hs-identifier hs-var">evalNumOp</span></a><span> </span><span class="hs-string">&quot;-&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679173302"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621679173303"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-94"></a><span class="hs-identifier">evalBinOp</span><span> </span><a href="Language.Syntax.html#Times"><span class="hs-identifier hs-var">Times</span></a><span> </span><a name="local-6989586621679173304"><a href="#local-6989586621679173304"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679173305"><a href="#local-6989586621679173305"><span class="hs-identifier">r</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Runtime.Eval.html#evalNumOp"><span class="hs-identifier hs-var">evalNumOp</span></a><span> </span><span class="hs-string">&quot;*&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">*</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679173304"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621679173305"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-95"></a><span class="hs-identifier">evalBinOp</span><span> </span><a href="Language.Syntax.html#Div"><span class="hs-identifier hs-var">Div</span></a><span> </span><a name="local-6989586621679173306"><a href="#local-6989586621679173306"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679173307"><a href="#local-6989586621679173307"><span class="hs-identifier">r</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Runtime.Eval.html#evalNumOp"><span class="hs-identifier hs-var">evalNumOp</span></a><span> </span><span class="hs-string">&quot;/&quot;</span><span> </span><span class="hs-identifier hs-var">div</span><span> </span><a href="#local-6989586621679173306"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621679173307"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-96"></a><span class="hs-identifier">evalBinOp</span><span> </span><a href="Language.Syntax.html#Mod"><span class="hs-identifier hs-var">Mod</span></a><span> </span><a name="local-6989586621679173804"><a href="#local-6989586621679173804"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679173805"><a href="#local-6989586621679173805"><span class="hs-identifier">r</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Runtime.Eval.html#evalNumOp"><span class="hs-identifier hs-var">evalNumOp</span></a><span> </span><span class="hs-string">&quot;%&quot;</span><span> </span><span class="hs-identifier hs-var">mod</span><span> </span><a href="#local-6989586621679173804"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621679173805"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-97"></a><span class="hs-identifier">evalBinOp</span><span> </span><a href="Language.Syntax.html#Less"><span class="hs-identifier hs-var">Less</span></a><span> </span><a name="local-6989586621679173806"><a href="#local-6989586621679173806"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679173807"><a href="#local-6989586621679173807"><span class="hs-identifier">r</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Runtime.Eval.html#evalCompareOpInt"><span class="hs-identifier hs-var">evalCompareOpInt</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679173806"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621679173807"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-98"></a><span class="hs-identifier">evalBinOp</span><span> </span><a href="Language.Syntax.html#Leq"><span class="hs-identifier hs-var">Leq</span></a><span> </span><a name="local-6989586621679173808"><a href="#local-6989586621679173808"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679173809"><a href="#local-6989586621679173809"><span class="hs-identifier">r</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Runtime.Eval.html#evalCompareOpInt"><span class="hs-identifier hs-var">evalCompareOpInt</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;=</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679173808"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621679173809"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-99"></a><span class="hs-identifier">evalBinOp</span><span> </span><a href="Language.Syntax.html#Equiv"><span class="hs-identifier hs-var">Equiv</span></a><span> </span><a name="local-6989586621679173810"><a href="#local-6989586621679173810"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679173811"><a href="#local-6989586621679173811"><span class="hs-identifier">r</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Runtime.Eval.html#evalEq"><span class="hs-identifier hs-var">evalEq</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679173810"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621679173811"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-100"></a><span class="hs-identifier">evalBinOp</span><span> </span><a href="Language.Syntax.html#NotEquiv"><span class="hs-identifier hs-var">NotEquiv</span></a><span> </span><a name="local-6989586621679173812"><a href="#local-6989586621679173812"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679173813"><a href="#local-6989586621679173813"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Runtime.Eval.html#evalEq"><span class="hs-identifier hs-var">evalEq</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679173812"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621679173813"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-101"></a><span class="hs-identifier">evalBinOp</span><span> </span><a href="Language.Syntax.html#Geq"><span class="hs-identifier hs-var">Geq</span></a><span> </span><a name="local-6989586621679173814"><a href="#local-6989586621679173814"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679173815"><a href="#local-6989586621679173815"><span class="hs-identifier">r</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Runtime.Eval.html#evalCompareOpInt"><span class="hs-identifier hs-var">evalCompareOpInt</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&gt;=</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679173814"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621679173815"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-102"></a><span class="hs-identifier">evalBinOp</span><span> </span><a href="Language.Syntax.html#Greater"><span class="hs-identifier hs-var">Greater</span></a><span> </span><a name="local-6989586621679173816"><a href="#local-6989586621679173816"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679173817"><a href="#local-6989586621679173817"><span class="hs-identifier">r</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Runtime.Eval.html#evalCompareOpInt"><span class="hs-identifier hs-var">evalCompareOpInt</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&gt;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679173816"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621679173817"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-103"></a><span class="hs-identifier">evalBinOp</span><span> </span><a href="Language.Syntax.html#Get"><span class="hs-identifier hs-var">Get</span></a><span> </span><a name="local-6989586621679173818"><a href="#local-6989586621679173818"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679173819"><a href="#local-6989586621679173819"><span class="hs-identifier">r</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-104"></a><span>   </span><a name="local-6989586621679173820"><a href="#local-6989586621679173820"><span class="hs-identifier">_board</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173818"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-105"></a><span>   </span><a name="local-6989586621679173821"><a href="#local-6989586621679173821"><span class="hs-identifier">pos</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173819"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-106"></a><span>   </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173820"><span class="hs-identifier hs-var">_board</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679173821"><span class="hs-identifier hs-var">pos</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-107"></a><span>      </span><span class="hs-special">(</span><a href="Runtime.Values.html#Vboard"><span class="hs-identifier hs-var">Vboard</span></a><span> </span><a name="local-6989586621679173822"><a href="#local-6989586621679173822"><span class="hs-identifier">arr</span></a></a><span class="hs-special">,</span><span> </span><a href="Runtime.Values.html#Vt"><span class="hs-identifier hs-var">Vt</span></a><span> </span><span class="hs-special">[</span><a href="Runtime.Values.html#Vi"><span class="hs-identifier hs-var">Vi</span></a><span> </span><a name="local-6989586621679173823"><a href="#local-6989586621679173823"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><a href="Runtime.Values.html#Vi"><span class="hs-identifier hs-var">Vi</span></a><span> </span><a name="local-6989586621679173824"><a href="#local-6989586621679173824"><span class="hs-identifier">y</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Eval.html#tryUnsafeBoardAccess"><span class="hs-identifier hs-var">tryUnsafeBoardAccess</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173823"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><a href="#local-6989586621679173824"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679173822"><span class="hs-identifier hs-var">arr</span></a><span>
</span><a name="line-108"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Values.html#Err"><span class="hs-identifier hs-var">Err</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Could not access &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679173819"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; on the board \n&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679173818"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-comment">-- | evaluates the == and /= operations</span><span>
</span><a name="line-111"></a><span class="hs-identifier">evalEq</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Runtime.Values.html#Val"><span class="hs-identifier hs-type">Val</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Values.html#Val"><span class="hs-identifier hs-type">Val</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621679172370"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621679172370"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Monad.html#Eval"><span class="hs-identifier hs-type">Eval</span></a><span> </span><a href="Runtime.Values.html#Val"><span class="hs-identifier hs-type">Val</span></a><span>
</span><a name="line-112"></a><a name="evalEq"><a href="Runtime.Eval.html#evalEq"><span class="hs-identifier">evalEq</span></a></a><span> </span><a name="local-6989586621679173825"><a href="#local-6989586621679173825"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679173826"><a href="#local-6989586621679173826"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679173827"><a href="#local-6989586621679173827"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-113"></a><span>                  </span><a name="local-6989586621679173828"><a href="#local-6989586621679173828"><span class="hs-identifier">v1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173826"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-114"></a><span>                  </span><a name="local-6989586621679173829"><a href="#local-6989586621679173829"><span class="hs-identifier">v2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173827"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-115"></a><span>                  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Values.html#Vb"><span class="hs-identifier hs-var">Vb</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173825"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679173828"><span class="hs-identifier hs-var">v1</span></a><span> </span><a href="#local-6989586621679173829"><span class="hs-identifier hs-var">v2</span></a><span class="hs-special">)</span><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span class="hs-comment">-- | evaluates comparison operations for only Ints (except for == &amp; /=)</span><span>
</span><a name="line-118"></a><span class="hs-identifier">evalCompareOpInt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621679172369"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621679172369"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Monad.html#Eval"><span class="hs-identifier hs-type">Eval</span></a><span> </span><a href="Runtime.Values.html#Val"><span class="hs-identifier hs-type">Val</span></a><span>
</span><a name="line-119"></a><a name="evalCompareOpInt"><a href="Runtime.Eval.html#evalCompareOpInt"><span class="hs-identifier">evalCompareOpInt</span></a></a><span> </span><a name="local-6989586621679173830"><a href="#local-6989586621679173830"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679173831"><a href="#local-6989586621679173831"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679173832"><a href="#local-6989586621679173832"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-120"></a><span>                     </span><a name="local-6989586621679173833"><a href="#local-6989586621679173833"><span class="hs-identifier">v1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173831"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-121"></a><span>                     </span><a name="local-6989586621679173834"><a href="#local-6989586621679173834"><span class="hs-identifier">v2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173832"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-122"></a><span>                     </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173833"><span class="hs-identifier hs-var">v1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679173834"><span class="hs-identifier hs-var">v2</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-123"></a><span>                        </span><span class="hs-special">(</span><a href="Runtime.Values.html#Vi"><span class="hs-identifier hs-var">Vi</span></a><span> </span><a name="local-6989586621679173835"><a href="#local-6989586621679173835"><span class="hs-identifier">l'</span></a></a><span class="hs-special">,</span><span> </span><a href="Runtime.Values.html#Vi"><span class="hs-identifier hs-var">Vi</span></a><span> </span><a name="local-6989586621679173836"><a href="#local-6989586621679173836"><span class="hs-identifier">r'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Runtime.Values.html#Vb"><span class="hs-identifier hs-var">Vb</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173830"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679173835"><span class="hs-identifier hs-var">l'</span></a><span> </span><a href="#local-6989586621679173836"><span class="hs-identifier hs-var">r'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>                        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Values.html#Err"><span class="hs-identifier hs-var">Err</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Could not compare &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679173831"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; to &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679173832"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span class="hs-comment">-- | evaluates numerical operations</span><span>
</span><a name="line-127"></a><span class="hs-identifier">evalNumOp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621679172368"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621679172368"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Monad.html#Eval"><span class="hs-identifier hs-type">Eval</span></a><span> </span><a href="Runtime.Values.html#Val"><span class="hs-identifier hs-type">Val</span></a><span>
</span><a name="line-128"></a><a name="evalNumOp"><a href="Runtime.Eval.html#evalNumOp"><span class="hs-identifier">evalNumOp</span></a></a><span> </span><a name="local-6989586621679173837"><a href="#local-6989586621679173837"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-6989586621679173838"><a href="#local-6989586621679173838"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679173839"><a href="#local-6989586621679173839"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679173840"><a href="#local-6989586621679173840"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-129"></a><span>   </span><span class="hs-keyword">do</span><span>
</span><a name="line-130"></a><span>        </span><a name="local-6989586621679173841"><a href="#local-6989586621679173841"><span class="hs-identifier">v1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173839"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-131"></a><span>        </span><a name="local-6989586621679173842"><a href="#local-6989586621679173842"><span class="hs-identifier">v2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173840"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-132"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173841"><span class="hs-identifier hs-var">v1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679173842"><span class="hs-identifier hs-var">v2</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-133"></a><span>          </span><span class="hs-comment">-- if div/mod and denominator is 0, report an error, otherwise proceed</span><span>
</span><a name="line-134"></a><span>          </span><span class="hs-special">(</span><a href="Runtime.Values.html#Vi"><span class="hs-identifier hs-var">Vi</span></a><span> </span><a name="local-6989586621679173843"><a href="#local-6989586621679173843"><span class="hs-identifier">l'</span></a></a><span class="hs-special">,</span><span> </span><a href="Runtime.Values.html#Vi"><span class="hs-identifier hs-var">Vi</span></a><span> </span><a name="local-6989586621679173844"><a href="#local-6989586621679173844"><span class="hs-identifier">r'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679173844"><span class="hs-identifier hs-var">r'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173837"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-string">&quot;/&quot;</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679173837"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-string">&quot;%&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-135"></a><span>                              </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Runtime.Values.html#Err"><span class="hs-identifier hs-var">Err</span></a><span> </span><span class="hs-string">&quot;Cannot divide by zero&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>                              </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Runtime.Values.html#Vi"><span class="hs-identifier hs-var">Vi</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173838"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679173843"><span class="hs-identifier hs-var">l'</span></a><span> </span><a href="#local-6989586621679173844"><span class="hs-identifier hs-var">r'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>          </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-138"></a><span>                  </span><a href="Runtime.Values.html#Err"><span class="hs-identifier hs-var">Err</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Could not do numerical operation on &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679173839"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; to &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679173840"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span class="hs-comment">-- | Evaluates an expression at runtime, producing a Val in the Eval monad</span><span>
</span><a name="line-141"></a><span class="hs-identifier">eval</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621679172367"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Monad.html#Eval"><span class="hs-identifier hs-type">Eval</span></a><span> </span><a href="Runtime.Values.html#Val"><span class="hs-identifier hs-type">Val</span></a><span>
</span><a name="line-142"></a><span class="hs-comment">-- evaluate an Annotation</span><span>
</span><a name="line-143"></a><a name="eval"><a href="Runtime.Eval.html#eval"><span class="hs-identifier">eval</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Annotation"><span class="hs-identifier hs-var">Annotation</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679173845"><a href="#local-6989586621679173845"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173845"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-144"></a><span class="hs-comment">-- evaluate an Integer</span><span>
</span><a name="line-145"></a><span class="hs-identifier">eval</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#I"><span class="hs-identifier hs-var">I</span></a><span> </span><a name="local-6989586621679173846"><a href="#local-6989586621679173846"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Values.html#Vi"><span class="hs-identifier hs-var">Vi</span></a><span> </span><a href="#local-6989586621679173846"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-146"></a><span class="hs-comment">-- evaluate a Boolean</span><span>
</span><a name="line-147"></a><span class="hs-identifier">eval</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#B"><span class="hs-identifier hs-var">B</span></a><span> </span><a name="local-6989586621679173847"><a href="#local-6989586621679173847"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Values.html#Vb"><span class="hs-identifier hs-var">Vb</span></a><span> </span><a href="#local-6989586621679173847"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-148"></a><span class="hs-comment">-- evaluate a Symbol</span><span>
</span><a name="line-149"></a><span class="hs-identifier">eval</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#S"><span class="hs-identifier hs-var">S</span></a><span> </span><a name="local-6989586621679173848"><a href="#local-6989586621679173848"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Values.html#Vs"><span class="hs-identifier hs-var">Vs</span></a><span> </span><a href="#local-6989586621679173848"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-150"></a><span class="hs-comment">-- evaluate a Tuple</span><span>
</span><a name="line-151"></a><span class="hs-identifier">eval</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Tuple"><span class="hs-identifier hs-var">Tuple</span></a><span> </span><a name="local-6989586621679173849"><a href="#local-6989586621679173849"><span class="hs-identifier">es</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173849"><span class="hs-identifier hs-var">es</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Runtime.Values.html#Vt"><span class="hs-identifier hs-var">Vt</span></a><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span class="hs-comment">-- evaluate a Ref</span><span>
</span><a name="line-153"></a><span class="hs-identifier">eval</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Ref"><span class="hs-identifier hs-var">Ref</span></a><span> </span><a name="local-6989586621679173850"><a href="#local-6989586621679173850"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-154"></a><span>  </span><a name="local-6989586621679173851"><a href="#local-6989586621679173851"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Monad.html#lookupName"><span class="hs-identifier hs-var">lookupName</span></a><span> </span><a href="#local-6989586621679173850"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-155"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679173852"><a href="#local-6989586621679173852"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621679173850"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="Runtime.Builtins.html#builtinRefs"><span class="hs-identifier hs-var">builtinRefs</span></a><span>
</span><a name="line-156"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173851"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679173852"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-157"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679173853"><a href="#local-6989586621679173853"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679173853"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-158"></a><span>          </span><span class="hs-comment">-- Pending Value, need to eval this to get the actual value</span><span>
</span><a name="line-159"></a><span>          </span><span class="hs-special">(</span><a href="Runtime.Values.html#Pv"><span class="hs-identifier hs-var">Pv</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679173854"><a href="#local-6989586621679173854"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Monad.html#evalWithLimit"><span class="hs-identifier hs-var">evalWithLimit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173854"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-160"></a><span>          </span><span class="hs-comment">-- normal value, return as is</span><span>
</span><a name="line-161"></a><span>          </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679173853"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-162"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679173855"><a href="#local-6989586621679173855"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679173855"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-163"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Values.html#Err"><span class="hs-identifier hs-var">Err</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Variable &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679173850"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; undefined&quot;</span><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span class="hs-comment">-- evalute a function application</span><span>
</span><a name="line-166"></a><span class="hs-identifier">eval</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621679173856"><a href="#local-6989586621679173856"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679173857"><a href="#local-6989586621679173857"><span class="hs-identifier">es</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-167"></a><span>  </span><a name="local-6989586621679173862"><a href="#local-6989586621679173862"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173857"><span class="hs-identifier hs-var">es</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679173858"><a href="#local-6989586621679173858"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679173858"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-168"></a><span>    </span><span class="hs-special">(</span><a href="Runtime.Values.html#Vt"><span class="hs-identifier hs-var">Vt</span></a><span> </span><span class="hs-special">[</span><a href="Runtime.Values.html#Vt"><span class="hs-identifier hs-var">Vt</span></a><span> </span><a name="local-6989586621679173859"><a href="#local-6989586621679173859"><span class="hs-identifier">args</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679173859"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-169"></a><span>    </span><span class="hs-special">(</span><a href="Runtime.Values.html#Vt"><span class="hs-identifier hs-var">Vt</span></a><span> </span><a name="local-6989586621679173860"><a href="#local-6989586621679173860"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679173860"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-170"></a><span>    </span><span class="hs-comment">-- not what we expected</span><span>
</span><a name="line-171"></a><span>    </span><a name="local-6989586621679173861"><a href="#local-6989586621679173861"><span class="hs-identifier">q</span></a></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><a href="Runtime.Values.html#Err"><span class="hs-identifier hs-var">Err</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Function application did not get the expected arguments from: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679173861"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-172"></a><span>  </span><a name="local-6989586621679173863"><a href="#local-6989586621679173863"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Monad.html#lookupName"><span class="hs-identifier hs-var">lookupName</span></a><span> </span><a href="#local-6989586621679173856"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-173"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679173863"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-174"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Runtime.Values.html#Vf"><span class="hs-identifier hs-var">Vf</span></a><span> </span><a name="local-6989586621679173864"><a href="#local-6989586621679173864"><span class="hs-identifier">params</span></a></a><span> </span><a name="local-6989586621679173865"><a href="#local-6989586621679173865"><span class="hs-identifier">env'</span></a></a><span> </span><a name="local-6989586621679173866"><a href="#local-6989586621679173866"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Monad.html#extScope"><span class="hs-identifier hs-var">extScope</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679173864"><span class="hs-identifier hs-var">params</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173862"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679173865"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Runtime.Monad.html#evalWithLimit"><span class="hs-identifier hs-var">evalWithLimit</span></a><span> </span><span class="hs-special">(</span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173866"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ++ env?</span><span>
</span><a name="line-175"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Runtime.Values.html#Pv"><span class="hs-identifier hs-var">Pv</span></a><span> </span><a name="local-6989586621679173867"><a href="#local-6989586621679173867"><span class="hs-identifier">env'</span></a></a><span> </span><a name="local-6989586621679173868"><a href="#local-6989586621679173868"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Monad.html#extScope"><span class="hs-identifier hs-var">extScope</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173862"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679173867"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Runtime.Monad.html#evalWithLimit"><span class="hs-identifier hs-var">evalWithLimit</span></a><span> </span><span class="hs-special">(</span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173868"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ++ env?</span><span>
</span><a name="line-176"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621679173856"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="Runtime.Builtins.html#builtins"><span class="hs-identifier hs-var">builtins</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-177"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679173869"><a href="#local-6989586621679173869"><span class="hs-identifier">f2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-178"></a><span>        </span><span class="hs-special">(</span><a href="#local-6989586621679173869"><span class="hs-identifier hs-var">f2</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173862"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-180"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Values.html#Err"><span class="hs-identifier hs-var">Err</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Couldn't find &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679173856"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; in the environment!&quot;</span><span>
</span><a name="line-181"></a><span>    </span><span class="hs-comment">-- incorrect kind of value was looked up from the environment</span><span>
</span><a name="line-182"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Values.html#Err"><span class="hs-identifier hs-var">Err</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679173856"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; was not correct when looking it up in the environment!&quot;</span><span>
</span><a name="line-183"></a><span>  </span><span class="hs-comment">-- TODO REMOVED WARNING</span><span>
</span><a name="line-184"></a><span>  </span><span class="hs-comment">--where</span><span>
</span><a name="line-185"></a><span>    </span><span class="hs-comment">--vals ((Vt xs):ys) = xs ++ (vals ys)</span><span>
</span><a name="line-186"></a><span>    </span><span class="hs-comment">--vals (x:xs) = x : vals xs</span><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-comment">-- evaluate a Let expression</span><span>
</span><a name="line-189"></a><span class="hs-identifier">eval</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-6989586621679173870"><a href="#local-6989586621679173870"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679173871"><a href="#local-6989586621679173871"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621679173872"><a href="#local-6989586621679173872"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-190"></a><span>  </span><a name="local-6989586621679173873"><a href="#local-6989586621679173873"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173871"><span class="hs-identifier hs-var">e1</span></a><span>
</span><a name="line-191"></a><span>  </span><a href="Runtime.Monad.html#extScope"><span class="hs-identifier hs-var">extScope</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173870"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679173873"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173872"><span class="hs-identifier hs-var">e2</span></a><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-comment">-- evaluate an If-Then-Else expression</span><span>
</span><a name="line-194"></a><span class="hs-identifier">eval</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#If"><span class="hs-identifier hs-var">If</span></a><span> </span><a name="local-6989586621679173874"><a href="#local-6989586621679173874"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621679173875"><a href="#local-6989586621679173875"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621679173876"><a href="#local-6989586621679173876"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-195"></a><span>  </span><a name="local-6989586621679173877"><a href="#local-6989586621679173877"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Monad.html#unpackBool"><span class="hs-identifier hs-var">unpackBool</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173874"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679173877"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-197"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679173878"><a href="#local-6989586621679173878"><span class="hs-identifier">bb</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679173878"><span class="hs-identifier hs-var">bb</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="Runtime.Monad.html#evalWithLimit"><span class="hs-identifier hs-var">evalWithLimit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173875"><span class="hs-identifier hs-var">e1</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="Runtime.Monad.html#evalWithLimit"><span class="hs-identifier hs-var">evalWithLimit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173876"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-198"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Values.html#Err"><span class="hs-identifier hs-var">Err</span></a><span> </span><a href="#local-6989586621679173879"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-199"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679173879"><a href="#local-6989586621679173879"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;The expression &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679173874"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; did not evaluate to a Bool as expected!&quot;</span><span>
</span><a name="line-200"></a><span>
</span><a name="line-201"></a><span class="hs-comment">-- evaluate a BinOp expression</span><span>
</span><a name="line-202"></a><span class="hs-identifier">eval</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Binop"><span class="hs-identifier hs-var">Binop</span></a><span> </span><a name="local-6989586621679173880"><a href="#local-6989586621679173880"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621679173881"><a href="#local-6989586621679173881"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621679173882"><a href="#local-6989586621679173882"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Runtime.Eval.html#evalBinOp"><span class="hs-identifier hs-var">evalBinOp</span></a><span> </span><a href="#local-6989586621679173880"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-6989586621679173881"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-6989586621679173882"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-comment">-- evaluate a while expression</span><span>
</span><a name="line-205"></a><span class="hs-identifier">eval</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#While"><span class="hs-identifier hs-var">While</span></a><span> </span><a name="local-6989586621679173883"><a href="#local-6989586621679173883"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621679173884"><a href="#local-6989586621679173884"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679173885"><a href="#local-6989586621679173885"><span class="hs-identifier">names</span></a></a><span> </span><a name="local-6989586621679173886"><a href="#local-6989586621679173886"><span class="hs-identifier">exprs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-206"></a><span>   </span><a name="local-6989586621679173888"><a href="#local-6989586621679173888"><span class="hs-identifier">c'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Monad.html#unpackBool"><span class="hs-identifier hs-var">unpackBool</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173883"><span class="hs-identifier hs-var">c</span></a><span>   </span><span class="hs-comment">-- evaluate the condition</span><span>
</span><a name="line-207"></a><span>   </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679173888"><span class="hs-identifier hs-var">c'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-208"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-209"></a><span>         </span><a name="local-6989586621679173889"><a href="#local-6989586621679173889"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Monad.html#getEnv"><span class="hs-identifier hs-var">getEnv</span></a><span>         </span><span class="hs-comment">-- get the current environment</span><span>
</span><a name="line-210"></a><span>         </span><a name="local-6989586621679173890"><a href="#local-6989586621679173890"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173884"><span class="hs-identifier hs-var">b</span></a><span>      </span><span class="hs-comment">-- evaluate the body</span><span>
</span><a name="line-211"></a><span>         </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679173890"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-keyword">of</span><span>        </span><span class="hs-comment">-- update the variables in the environment w/ new values and recurse:</span><span>
</span><a name="line-212"></a><span>            </span><span class="hs-special">(</span><a href="Runtime.Values.html#Vt"><span class="hs-identifier hs-var">Vt</span></a><span> </span><a name="local-6989586621679173891"><a href="#local-6989586621679173891"><span class="hs-identifier">vs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Monad.html#extScope"><span class="hs-identifier hs-var">extScope</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679173885"><span class="hs-identifier hs-var">names</span></a><span> </span><a href="#local-6989586621679173891"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679173889"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679173887"><span class="hs-identifier hs-var">recurse</span></a><span>
</span><a name="line-213"></a><span>            </span><a name="local-6989586621679173892"><a href="#local-6989586621679173892"><span class="hs-identifier">r</span></a></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Monad.html#extScope"><span class="hs-identifier hs-var">extScope</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621679173885"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679173892"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679173889"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679173887"><span class="hs-identifier hs-var">recurse</span></a><span> </span><span class="hs-comment">-- that head should never fail...</span><span>
</span><a name="line-214"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-215"></a><span>        </span><a name="local-6989586621679173893"><a href="#local-6989586621679173893"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173886"><span class="hs-identifier hs-var">exprs</span></a><span>
</span><a name="line-216"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679173893"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-217"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Values.html#Err"><span class="hs-identifier hs-var">Err</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;The expression &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679173883"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-218"></a><span>                                     </span><span class="hs-string">&quot; did not evaluate to a Bool as expected!&quot;</span><span>
</span><a name="line-219"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-220"></a><span>      </span><a name="local-6989586621679173887"><a href="#local-6989586621679173887"><span class="hs-identifier">recurse</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Runtime.Monad.html#evalWithLimit"><span class="hs-identifier hs-var">evalWithLimit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#While"><span class="hs-identifier hs-var">While</span></a><span> </span><a href="#local-6989586621679173883"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621679173884"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679173885"><span class="hs-identifier hs-var">names</span></a><span> </span><a href="#local-6989586621679173886"><span class="hs-identifier hs-var">exprs</span></a><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-comment">-- evaluate a type hole</span><span>
</span><a name="line-223"></a><span class="hs-identifier">eval</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#HE"><span class="hs-identifier hs-var">HE</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Runtime.Monad.html#err"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Type hole: &quot;</span><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span class="hs-comment">-- | Runs an expression under a given environment and a given buffer, producing</span><span>
</span><a name="line-226"></a><span class="hs-comment">-- a result of either a list of values and a buffer, or a list of values and a single value</span><span>
</span><a name="line-227"></a><span class="hs-identifier">runWithBuffer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Runtime.Monad.html#Env"><span class="hs-identifier hs-type">Env</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Monad.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><span class="hs-identifier hs-type">SourcePos</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Runtime.Values.html#Val"><span class="hs-identifier hs-type">Val</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Runtime.Monad.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Runtime.Values.html#Val"><span class="hs-identifier hs-type">Val</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Runtime.Values.html#Val"><span class="hs-identifier hs-type">Val</span></a><span class="hs-special">)</span><span>
</span><a name="line-228"></a><a name="runWithBuffer"><a href="Runtime.Eval.html#runWithBuffer"><span class="hs-identifier">runWithBuffer</span></a></a><span> </span><a name="local-6989586621679173894"><a href="#local-6989586621679173894"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679173895"><a href="#local-6989586621679173895"><span class="hs-identifier">buf</span></a></a><span> </span><a name="local-6989586621679173896"><a href="#local-6989586621679173896"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-229"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679173902"><a href="#local-6989586621679173902"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Runtime.Monad.html#runEval"><span class="hs-identifier hs-var">runEval</span></a><span> </span><a href="#local-6989586621679173894"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679173895"><span class="hs-identifier hs-var">buf</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173897"><span class="hs-identifier hs-var">eval'</span></a><span> </span><a href="#local-6989586621679173896"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-230"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679173902"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-231"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="Runtime.Monad.html#NeedInput"><span class="hs-identifier hs-var">NeedInput</span></a><span> </span><a name="local-6989586621679173903"><a href="#local-6989586621679173903"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173903"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679173895"><span class="hs-identifier hs-var">buf</span></a><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679173904"><a href="#local-6989586621679173904"><span class="hs-identifier">boards</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679173905"><a href="#local-6989586621679173905"><span class="hs-identifier">val</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173904"><span class="hs-identifier hs-var">boards</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679173905"><span class="hs-identifier hs-var">val</span></a><span class="hs-special">)</span><span>
</span><a name="line-233"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="Runtime.Monad.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a name="local-6989586621679173906"><a href="#local-6989586621679173906"><span class="hs-identifier">er</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Runtime.Values.html#Err"><span class="hs-identifier hs-var">Err</span></a><span> </span><a href="#local-6989586621679173906"><span class="hs-identifier hs-var">er</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- not good</span><span>
</span><a name="line-234"></a><span>      </span><span class="hs-comment">-- TODO REMOVED REDUNDANT</span><span>
</span><a name="line-235"></a><span>      </span><span class="hs-comment">--Left er             -&gt; Right $ ([], Err (&quot;Bad Error (Not Good): &quot; ++ (show er))) -- not good</span><span>
</span><a name="line-236"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-237"></a><span>      </span><span class="hs-identifier">eval'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.Syntax.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621679173898"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Runtime.Monad.html#Eval"><span class="hs-identifier hs-type">Eval</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Runtime.Values.html#Val"><span class="hs-identifier hs-type">Val</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Runtime.Values.html#Val"><span class="hs-identifier hs-type">Val</span></a><span class="hs-special">)</span><span>
</span><a name="line-238"></a><span>      </span><a name="local-6989586621679173897"><a href="#local-6989586621679173897"><span class="hs-identifier">eval'</span></a></a><span> </span><a name="local-6989586621679173899"><a href="#local-6989586621679173899"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-239"></a><span>         </span><a name="local-6989586621679173900"><a href="#local-6989586621679173900"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><a href="Runtime.Eval.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679173899"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-240"></a><span>         </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679173901"><a href="#local-6989586621679173901"><span class="hs-identifier">boards</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">get</span><span>
</span><a name="line-241"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679173901"><span class="hs-identifier hs-var">boards</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679173900"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-242"></a></pre></body></html>